# 路径规划与导航可视化系统

## 项目概述

这是一个基于C++和SFML库开发的高级路径规划与导航可视化系统，实现了大规模地图生成、A*路径搜索算法以及动态交通模拟功能。该系统旨在为路径规划算法研究、交通流分析和导航系统开发提供直观的可视化环境。

## 系统架构

系统采用模块化设计，由四个核心组件构成，各组件之间通过明确的接口进行交互，形成完整的路径规划与可视化流程：

1. **地图生成器(MapGenerator)** - 创建和管理导航地图数据结构
2. **路径查找器(PathFinder)** - 实现最优路径搜索算法
3. **交通模拟器(TrafficSimulator)** - 模拟实时交通流变化
4. **导航可视化器(NavigationVisualizer)** - 提供交互式图形界面

## 功能特性

- **大规模地图生成**：支持生成包含上万个顶点的复杂导航地图
- **高效路径规划**：使用A*算法实现最优路径搜索
- **动态交通模拟**：模拟交通流量变化，实时更新道路权重
- **交互式可视化**：支持地图缩放、平移、路径查询等交互操作
- **空间索引优化**：使用KD树加速空间查询，提高大规模数据集下的性能
- **距离计算优化**：通过邻域范围查询减少不必要的边计算
- **多线程支持**：分离交通模拟和渲染过程，提高系统响应性能

## 核心组件详解

### 1. 地图生成器 (MapGenerator)

负责生成随机地图数据，包括顶点和边的创建与管理：
- 使用随机分布在指定区域内生成顶点坐标
- 基于距离阈值连接相邻顶点，构建导航网络
- 提供地图数据的二进制序列化与反序列化功能
- 支持TSV格式导出顶点和边信息，便于数据分析
- 使用KD树优化邻近顶点查询，提高生成效率

### 2. 路径查找器 (PathFinder)

实现A*路径规划算法：
- 使用优先队列优化节点扩展顺序
- 结合欧几里得距离和交通权重计算启发式函数
- 支持动态交通权重的路径计算，实现实时路径优化
- 限制最大搜索节点数，避免在大规模地图上的性能问题
- 提供邻居节点快速查询功能

### 3. 交通模拟器 (TrafficSimulator)

模拟真实交通流量变化：
- 随机更新道路上的车辆数量，模拟交通波动
- 基于车辆密度动态调整道路权重
- 实现基于密度的旅行时间计算模型
- 使用线程安全机制确保数据一致性
- 支持长时间稳定运行的交通状态演化

### 4. 导航可视化器 (NavigationVisualizer)

提供交互式图形界面：
- 使用SFML渲染地图、路径和交通状态
- 支持地图缩放和平移操作
- 实现顶点和边的选择与高亮
- 显示实时帧率和操作状态
- 支持焦点区域查询，高亮显示特定范围内的顶点和边

## 技术栈

- **编程语言**: C++
- **图形库**: SFML (Simple and Fast Multimedia Library)
- **空间索引**: nanoflann (KD树实现)
- **构建工具**: Visual Studio
- **并发支持**: C++11 线程库

## 项目结构

```
visualization/
├── main.cpp                 # 程序入口点
├── map_generation.h/cpp     # 地图生成相关代码
├── path_finder.h/cpp        # 路径规划算法实现
├── traffic_stimulator.h     # 交通模拟功能
├── visualization.h/cpp      # 可视化界面实现
├── quadtree.h               # 四叉树空间索引（备用）
├── nanoflann.hpp            # KD树空间索引库
├── include/                 # 第三方库头文件
│   └── nanoflann.hpp
├── resources/               # 字体等资源文件
│   ├── arial.ttf            # Arial字体文件
│   └── ...                  # 其他字体文件
└── visualization.sln        # Visual Studio解决方案文件
```

## 关键算法详解

### 地图生成算法

1. 在指定半径范围内随机生成顶点坐标
2. 使用KD树快速查找每个顶点的邻近点
3. 在最大距离阈值内连接顶点形成边
4. 计算并存储边的距离和初始权重
5. 确保生成的图具有良好的连通性

### A*路径搜索

1. 初始化开放列表和关闭列表
2. 计算起点到终点的启发式距离
3. 将起点加入开放列表
4. 当开放列表不为空时：
   - 从开放列表中取出f值最小的节点
   - 如果是目标节点，构建并返回路径
   - 将节点加入关闭列表
   - 扩展所有邻居节点，更新g值和父节点信息
5. 如果无法找到路径，返回空路径

### 交通流量模型

1. 基于以下公式计算动态权重：
   ```
   dynamic_weight = distance * (1 + 0.5 * pow(density, 2))
   ```
   其中density = current_vehicles / capacity

2. 旅行时间计算公式：
   ```
   travel_time = c * distance * (1.0 + (x > threshold) ? e * (x - threshold) : 0)
   ```
   其中c为时间系数，x为密度，threshold为拥堵阈值，e为拥堵系数

## 安装与配置

### 环境要求

- Visual Studio 2019或更高版本
- Windows操作系统
- SFML 2.x库

### 构建与运行

1. 使用Visual Studio打开 `visualization.sln` 解决方案
2. 确保SFML库已正确配置（库文件已包含在项目中）
3. 选择适当的配置（Debug/Release）和平台（x64）
4. 编译解决方案
5. 运行生成的可执行文件

## 使用指南

### 交互操作

- **鼠标操作**：
  - 左键点击：选择路径起点和终点
  - 滚轮：缩放地图
  - 右键拖动：平移地图视图

- **键盘操作**：
  - 按空格键：切换交通状态显示
  - 按R键：重新生成地图
  - 按ESC键：重置路径选择
  - 按F键：显示/隐藏焦点区域

### 交通状态指示

- **紫色道路**：交通畅通（车辆密度 < 0.3）
- **橙色道路**：交通中等拥堵（0.3 ≤ 车辆密度 < 0.6）
- **青色道路**：交通拥堵（车辆密度 ≥ 0.6）

## 性能特性

- 地图生成：10000个顶点约需1.5秒
- 路径查找：对于大规模地图，搜索范围限制为7000个节点
- 实时渲染：支持高帧率地图显示和交互
- 内存占用：大规模地图（10000顶点）约占用几百MB内存

## 故障排除

### 常见问题

1. **字体加载失败**
   - 错误信息：`Failed to load font "xxx.ttf"`
   - 解决方案：确保资源文件夹包含有效的字体文件，程序会尝试加载多个字体，部分失败不影响基本功能

2. **路径搜索超时**
   - 症状：无法找到路径或搜索时间过长
   - 解决方案：尝试选择更近的起点和终点，或减小地图规模

3. **性能问题**
   - 症状：帧率低或程序运行缓慢
   - 解决方案：减小地图规模（修改main.cpp中的N值），或关闭不必要的显示功能

## 应用场景

- 城市交通网络规划与模拟
- 自动驾驶路径规划算法验证
- 机器人导航系统开发
- 大规模网络拓扑分析
- 路径规划算法教学演示

## 未来改进方向

- 支持更多地图生成算法（如 Voronoi 图）
- 实现更复杂的交通流模型，包括交通信号灯和路口规则
- 添加交通拥堵预测功能
- 支持实时交通数据导入
- 优化大规模地图的渲染性能
- 添加多路径比较功能
- 实现三维地图可视化
- 支持地图编辑和障碍物添加

## 应用场景

- 城市交通网络规划与模拟
- 自动驾驶路径规划算法验证
- 机器人导航系统开发
- 大规模网络拓扑分析

## 未来改进方向

- 支持更多地图生成算法（如 Voronoi 图）
- 实现更复杂的交通流模型
- 添加交通信号灯和路口规则
- 支持实时交通数据导入
- 优化大规模地图的渲染性能